<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedido de Viaje - Grupo Idea</title>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      color: #2b375a;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #2b375a;
      color: white;
      padding: 10px 20px;
      text-align: center;
    }
    h2 {
      color: #d61c42;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background-color: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 6px;
      margin-top: 3px;
      box-sizing: border-box;
      font-size: 14px;
    }
    button {
      background-color: #2b375a;
      color: white;
      padding: 8px 12px;
      margin-top: 15px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #d61c42;
    }
    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 4px 8px;
      text-align: left;
      font-size: 13px;
    }
    .inline-fields {
      display: flex;
      gap: 10px;
    }
    .inline-fields > div {
      flex: 1;
    }
  </style>
</head>
<body>
  <header>
    <h1>Grupo Idea - Pedido de Viaje</h1>
  </header>
  <div class="container">
    <h2>Formulario de Pedido</h2>
    <form id="formViaje">
      <div class="inline-fields">
        <div>
          <label for="fechaDesde">Desde:</label>
          <input type="datetime-local" id="fechaDesde" name="fechaDesde" required>
        </div>
        <div>
          <label for="fechaHasta">Hasta:</label>
          <input type="datetime-local" id="fechaHasta" name="fechaHasta" required>
        </div>
        <div>
          <!--<label for="dias">Días a viajar:</label>-->
          <input type="hidden" id="dias" name="dias" required readonly>
        </div>
      </div>

      <label for="obraSelect">Obras a visitar:</label>
      <select id="obraSelect"></select>
      <!--<button type="button" onclick="agregarObra()">Agregar Obra</button>-->
      <table id="tablaObras">
        <thead><tr><th>Obra</th><th>Acción</th></tr></thead>
        <tbody></tbody>
      </table>

      <label for="descripcion">Descripción del viaje:</label>
      <textarea id="descripcion" name="descripcion" required></textarea>

      <label for="responsable">Responsable de rendición:</label>
      <select id="responsable" name="responsable" required></select>

      <label for="personalSelect">Personal que viaja:</label>
      <select id="personalSelect"></select>
      <!--<button type="button" onclick="agregarPersonal()">Agregar Personal</button>-->
      <table id="tablaPersonal">
        <thead><tr><th>Nombre</th><th>Acción</th></tr></thead>
        <tbody></tbody>
      </table>

      <label for="transporte">Transporte:</label>
      <select id="transporte" name="transporte" required></select>

      <div id="camposPasaje" style="display:none; margin-top:10px;">
        <label for="origenPasaje">Origen del pasaje:</label>
        <input type="text" id="origenPasaje" name="origenPasaje">

        <label for="destinoPasaje">Destino del pasaje:</label>
        <input type="text" id="destinoPasaje" name="destinoPasaje">
      </div>

      <div style="margin-top:10px;">
        <label style="display: flex; align-items: center; gap: 6px; font-weight: normal;">
          <input type="checkbox" id="hospedaje" name="hospedaje" style="width: 22px; height: 22px; margin-right: 6px;">
          Solicitar hospedaje
        </label>
      </div>
      
      <div id="campoLocalidad" style="display:none; margin-top:10px;">
        <label for="localidadHospedaje">Localidad del hospedaje:</label>
        <input type="text" id="localidadHospedaje" name="localidadHospedaje">
      </div>

      <label for="gastosRendir">¿Solicitás Gastos a rendir (aparte de los viáticos)?</label>
      <select id="gastosRendir" name="gastosRendir" required>
        <option value="">Elige</option>
        <option value="no">No</option>
        <option value="si">Sí</option>
      </select>

      <div id="montoOpciones" style="display:none; margin-top:8px;">
        <label for="montoSelect">Seleccioná un monto sugerido:</label>
        <select id="montoSelect">
          <option value="">Elige</option>
          <option value="50000">Técnico o MM $50.000</option>
          <option value="100000">Operarios hasta 1 semana $100.000</option>
          <option value="200000">Operarios más de 1 semana $200.000</option>
          <option value="manual">Ingresar importe manualmente</option>
        </select>
        <input type="number" id="montoManual" placeholder="Ingrese importe" style="display:none; margin-top:6px;">
      </div>
      <input type="hidden" id="monto" name="monto" value="0">

      <label for="detalle">Detalle:</label>
      <textarea id="detalle" name="detalle"></textarea>

      <div style="display: flex; justify-content: space-between; margin-top: 20px;">
        <button type="button" onclick="window.location.href='index.html'">Volver</button>
        <button type="submit">Enviar Pedido</button>
      </div>
    </form>
  </div>

  <script>
    const obraSelect = document.getElementById("obraSelect");
    const personalSelect = document.getElementById("personalSelect");
    const responsableSelect = document.getElementById("responsable");
    const transporteSelect = document.getElementById("transporte");
    const tablaObras = document.getElementById("tablaObras").querySelector("tbody");
    const tablaPersonal = document.getElementById("tablaPersonal").querySelector("tbody");

    const obrasSeleccionadas = [];
    const personalSeleccionado = [];
    
    const camposPasaje = document.getElementById("camposPasaje");
    const origenPasaje = document.getElementById("origenPasaje");
    const destinoPasaje = document.getElementById("destinoPasaje");
    
    const hospedajeCheckbox = document.getElementById("hospedaje");
    const campoLocalidad = document.getElementById("campoLocalidad");
    const localidadHospedaje = document.getElementById("localidadHospedaje");
    
    hospedajeCheckbox.addEventListener("change", function() {
      if (hospedajeCheckbox.checked) {
        campoLocalidad.style.display = "block";
        localidadHospedaje.required = true;
      } else {
        campoLocalidad.style.display = "none";
        localidadHospedaje.required = false;
        localidadHospedaje.value = "";
      }
    });
    transporteSelect.addEventListener("change", function() {
      if (transporteSelect.value === "pasaje") {
        camposPasaje.style.display = "block";
        origenPasaje.required = true;
        destinoPasaje.required = true;
      } else {
        camposPasaje.style.display = "none";
        origenPasaje.required = false;
        destinoPasaje.required = false;
        origenPasaje.value = "";
        destinoPasaje.value = "";
      }
    });
    

    async function cargarDatos() {
      try {
        const [obrasRes, personalRes, responsablesRes, transporteRes] = await Promise.all([
          fetch("https://grupo-idea-backend-1.onrender.com/api/obras"),
          fetch("https://grupo-idea-backend-1.onrender.com/api/personal"),
          fetch("https://grupo-idea-backend-1.onrender.com/api/usuarios"),
          fetch("https://grupo-idea-backend-1.onrender.com/api/transportes")
        ]);

        const obras = await obrasRes.json();
        const personas = await personalRes.json();
        const responsables = await responsablesRes.json();
        const transportes = await transporteRes.json();

        [obraSelect, personalSelect, responsableSelect, transporteSelect].forEach(sel => {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "-- Seleccione --";
          sel.appendChild(opt);
        });

        obras.forEach(o => {
          const opt = document.createElement("option");
          opt.value = o.id;
          opt.textContent = `PI: ${o.id} Obra: ${o.nombre}`;
          obraSelect.appendChild(opt);
        });

        personas.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = `Codigo: ${p.id} Personal: ${p.nombre}`;
          personalSelect.appendChild(opt);
        });

        responsables.forEach(r => {
          const opt = document.createElement("option");
          opt.value = r.id;
          opt.textContent = r.nombre;
          responsableSelect.appendChild(opt);
        });

        transportes.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.nombre;
          transporteSelect.appendChild(opt);
        });

        const optPasaje = document.createElement("option");
        optPasaje.value = "pasaje";
        optPasaje.textContent = "Comprar pasaje";
        transporteSelect.appendChild(optPasaje);

        const optSeminarios = document.createElement("option");
        optSeminarios.value = "Otros";
        optSeminarios.textContent = "Seminarios y capacitaciones";
        obraSelect.appendChild(optSeminarios);

      } catch (err) {
        alert("Error cargando datos: " + err);
      }
    }
    cargarDatos();

    function actualizarDescripcionAuto() {
      if (obrasSeleccionadas.length > 0 && document.getElementById("fechaDesde").value) {
        const nombreObra = obrasSeleccionadas[0].nombre;
        const fechaCompleta = document.getElementById("fechaDesde").value;
        const fechaSolo = fechaCompleta.split("T")[0]; // Solo la fecha (YYYY-MM-DD)
        document.getElementById("descripcion").value = `Viaje a ${nombreObra} el ${fechaSolo}`;
      }
    }


    function agregarObra() {
      const id = obraSelect.value;
      const nombre = obraSelect.options[obraSelect.selectedIndex].text;
      if (!obrasSeleccionadas.some(o => o.id === id)) {
        obrasSeleccionadas.push({ id, nombre });
        const row = tablaObras.insertRow();
        row.innerHTML = `<td>${nombre}</td><td><button type="button" onclick="eliminarFila(this, 'obras')">Quitar</button></td>`;
        actualizarDescripcionAuto();
      }
      if (id === "Otros") {
        const respuesta = prompt("Ingrese el lugar del seminario o capacitación:");
        let detalle = document.getElementById("detalle").value;   
         if (respuesta !== null) {
            detalle += (detalle ? "\n" : "") +
            "Seminario o capacitación a realizarse en: " + respuesta;
          }
        document.getElementById("detalle").value = detalle;
        }
      }
    obraSelect.addEventListener("change", function() {
      if (obraSelect.value) {
        agregarObra();
        // Deja el select vacío y actualiza Select2
        obraSelect.selectedIndex = 0;
        $('#obraSelect').val('').trigger('change');
      }
    });
        
    function agregarPersonal() {
      const id = personalSelect.value;
      const nombre = personalSelect.options[personalSelect.selectedIndex].text;
      if (!personalSeleccionado.some(p => p.id === id)) {
        personalSeleccionado.push({ id, nombre });
        const row = tablaPersonal.insertRow();
        row.innerHTML = `<td>${nombre}</td><td><button type="button" onclick="eliminarFila(this, 'personal')">Quitar</button></td>`;
      }
    }

    personalSelect.addEventListener("change", function() {
      if (personalSelect.value) {
        agregarPersonal();
        personalSelect.selectedIndex = 0;
        $('#personalSelect').val('').trigger('change');
      }
    });
    function eliminarFila(btn, tipo) {
      const row = btn.parentNode.parentNode;
      const nombre = row.cells[0].textContent;
      row.remove();
      if (tipo === 'obras') {
        const idx = obrasSeleccionadas.findIndex(o => o.nombre === nombre);
        if (idx > -1) obrasSeleccionadas.splice(idx, 1);
      } else {
        const idx = personalSeleccionado.findIndex(p => p.nombre === nombre);
        if (idx > -1) personalSeleccionado.splice(idx, 1);
      }
    }


    function obtenerObrasParaEnviar() {
      // Si la única obra seleccionada es "Otros", se devuelve null
      if (obrasSeleccionadas.length === 1 && obrasSeleccionadas[0].id === "Otros") {
        return null;
      }

      // Si hay varias y alguna es "Otros", se excluye
      return obrasSeleccionadas
        .filter(o => o.id !== "Otros")
        .map(o => parseInt(o.id)); // asegúrate que sean enteros
    }

    function calcularDias() {
      const desde = document.getElementById("fechaDesde").value;
      const hasta = document.getElementById("fechaHasta").value;
      const diasInput = document.getElementById("dias");
      if (desde && hasta) {
        const fechaDesde = new Date(desde);
        const fechaHasta = new Date(hasta);
        // Diferencia en milisegundos
        const diffMs = fechaHasta - fechaDesde;
        // Diferencia en días (redondeando hacia arriba)
        const diffDias = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
        diasInput.value = diffDias > 0 ? diffDias : 1;
      } else {
        diasInput.value = "";
      }
    }

document.getElementById("fechaDesde").addEventListener("change", calcularDias);
document.getElementById("fechaHasta").addEventListener("change", calcularDias);

document.getElementById("formViaje").addEventListener("submit", async e => {
  e.preventDefault();
  let detalleFinal = document.getElementById("detalle").value;
  if (transporteSelect.value === "pasaje") {
    detalleFinal += (detalleFinal ? "\n" : "") +
      "Pasajes:\n" +
      "Origen: " + origenPasaje.value + "\n" +
      "Destino: " + destinoPasaje.value;
  }
  if (hospedajeCheckbox.checked) {
    detalleFinal += (detalleFinal ? "\n" : "") +
      "Hospedaje solicitado en: " + localidadHospedaje.value;
  }
  const idTransporte = transporteSelect.value === "pasaje" ? null : Number(transporteSelect.value);
  const idObra = obraSelect.value === "Otros" ? null : Number(obraSelect.value);

  const datos = {
    dias: Number(document.getElementById("dias").value),
    fechaDesde: document.getElementById("fechaDesde").value,
    fechaHasta: document.getElementById("fechaHasta").value,
    obras: obtenerObrasParaEnviar(),
    personal: personalSeleccionado.map(p => p.id),
    IdTransporte: idTransporte,
    monto: Number(document.getElementById("monto").value),
    IdResponsableRendicion: Number(responsableSelect.value),
    descripcion: document.getElementById("descripcion").value,
    detalle: detalleFinal,
    IdUsuarioSolicitante: Number(localStorage.getItem("idUsuario")),
    nombreUsuarioSolicitante: localStorage.getItem("nombre"), 
    alojamiento: hospedajeCheckbox.checked ? "Sí" : "No",
    localidad: hospedajeCheckbox.checked ? localidadHospedaje.value : ""
  };
    
      try {
        const res = await fetch("https://grupo-idea-backend-1.onrender.com/api/pedidos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos)
        });
        const json = await res.json();
        if (json.ok) {
          alert("Pedido enviado. Número de pedido: " + json.idPedido);
          window.location.href = "index.html"; // Redirige al menú principal correcto
        } else {
          alert("Error al guardar el pedido: " + (json.error || JSON.stringify(json)));
        }
      } catch (err) {
        alert("Error de conexión: " + err);
      }
    });

    $(document).ready(function() {
  $('#obraSelect').select2({ width: '100%' });
  $('#personalSelect').select2({ width: '100%' });
  $('#responsable').select2({ width: '100%' });
  
  // Para obras
  $('#obraSelect').on('select2:select', function (e) {
    agregarObra();
    $('#obraSelect').val('').trigger('change');
  });

  // Para personal
  $('#personalSelect').on('select2:select', function (e) {
    agregarPersonal();
    $('#personalSelect').val('').trigger('change');
  });
});
const gastosRendir = document.getElementById("gastosRendir");
const montoOpciones = document.getElementById("montoOpciones");
const montoSelect = document.getElementById("montoSelect");
const montoManual = document.getElementById("montoManual");
const montoInput = document.getElementById("monto");

gastosRendir.addEventListener("change", function() {
  if (this.value === "si") {
    montoOpciones.style.display = "block";
    montoInput.value = "";
  } else {
    montoOpciones.style.display = "none";
    montoInput.value = "0";
  }
});

montoSelect.addEventListener("change", function() {
  if (this.value === "manual") {
    montoManual.style.display = "inline-block";
    montoManual.value = "";
    montoInput.value = "";
  } else if (this.value) {
    montoManual.style.display = "none";
    montoInput.value = this.value;
  } else {
    montoManual.style.display = "none";
    montoInput.value = "";
  }
});

montoManual.addEventListener("input", function() {
  montoInput.value = this.value;
});
  </script>
</body>
</html>
